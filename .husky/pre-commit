#!/usr/bin/env bash
set -Eeuo pipefail

# -----------------------------
# Package manager configuration
# You can set this to: pn, pnpm, npm, yarn, bun
# -----------------------------
PACKAGE_MANAGER="${PACKAGE_MANAGER:-pnpm}"

# Auto-detect a working package manager if the chosen one isn't found
if ! command -v "$PACKAGE_MANAGER" >/dev/null 2>&1; then
  for pm in pn pnpm npm yarn bun; do
    if command -v "$pm" >/dev/null 2>&1; then
      PACKAGE_MANAGER="$pm"
      break
    fi
  done
fi

if ! command -v "$PACKAGE_MANAGER" >/dev/null 2>&1; then
  echo "Error: could not find a package manager (looked for pn, pnpm, npm, yarn, bun)." >&2
  exit 127
fi

# -----------------------------
# Colors (disable if not TTY or NO_COLOR is set)
# -----------------------------
if [ ! -t 1 ] || [ -n "${NO_COLOR:-}" ]; then
  red=""; green=""; yellow=""; blue=""; magenta=""; cyan=""; gray=""; clear=""
  light_red=""; light_green=""; light_yellow=""; light_blue=""; light_magenta=""; light_cyan=""; white=""
else
  red='\033[1;31m'
  green='\033[1;32m'
  yellow='\033[1;33m'
  blue='\033[1;34m'
  magenta='\033[1;35m'
  cyan='\033[1;36m'
  gray='\033[1;90m'
  clear='\033[0m'
  light_red='\033[1;91m'
  light_green='\033[1;92m'
  light_yellow='\033[1;93m'
  light_blue='\033[1;94m'
  light_magenta='\033[1;95m'
  light_cyan='\033[1;96m'
  white='\033[1;97m'
fi

# -----------------------------
# Tunable estimate for the progress bar (seconds)
# -----------------------------
PROGRESS_ESTIMATE_SECS="${PROGRESS_ESTIMATE_SECS:-60}"

# -----------------------------
# Progress bar
# -----------------------------
progress_bar() {
  local pid="$1"
  local delay=0.1
  local spinner=('â ‹' 'â ™' 'â ¹' 'â ¸' 'â ¼' 'â ´' 'â ¦' 'â §' 'â ‡' 'â ')
  local spinner_idx=0
  local progress_char="â–‡"
  local width=50
  local start_time elapsed_time progress elapsed current_time spin

  start_time=$(date +%s)
  while kill -0 "$pid" 2>/dev/null; do
    current_time=$(date +%s)
    elapsed_time=$(( current_time - start_time ))

    # Time-based progress approximation
    progress=$(( elapsed_time * 100 / PROGRESS_ESTIMATE_SECS ))
    (( progress > 99 )) && progress=99

    elapsed=$(( progress * width / 100 ))
    spin=${spinner[$((spinner_idx % 10))]}
    spinner_idx=$(( spinner_idx + 1 ))

    printf "${green}\r[%s] [" "$spin"
    for ((i = 0; i < elapsed; i++)); do printf "%s" "${progress_char}"; done
    for ((i = elapsed; i < width; i++)); do printf " "; done
    printf "] %d%% (%ds)${clear}" "$progress" "$elapsed_time"

    sleep "$delay"
  done

  # Complete bar at 100%
  current_time=$(date +%s)
  elapsed_time=$(( current_time - start_time ))
  printf "${green}\r[âœ“] ["
  for ((i = 0; i < width; i++)); do printf "%s" "${progress_char}"; done
  printf "] 100%% (%ds)${clear}\n\n" "$elapsed_time"
}

# -----------------------------
# Utility: run a task with spinner, capture logs, print result
# -----------------------------
run_task() {
  local title="$1"
  local cmd="$2"
  local log_file="$3"

  echo -e "${yellow}${title}...${clear}\n"
  ( eval "$cmd" >"$log_file" 2>&1 ) &
  local task_pid=$!

  progress_bar "$task_pid"
  if ! wait "$task_pid"; then
    echo -e "${yellow}${title} output:${clear}"
    cat "$log_file"
    echo -e "${red}${title} failed...${clear} âŒ"
    return 1
  fi

  # Always show output, even on success
  echo -e "${yellow}${title} output:${clear}"
  cat "$log_file"
  echo -e "${green}${title} passed...${clear} âœ…"
  echo
}

# -----------------------------
# ASCII Art Banner
# -----------------------------
echo -e "
${green}
    _    ____  ____    _   _    _    __  __ _____ 
   / \  |  _ \|  _ \  | \ | |  / \  |  \/  | ____|
  / _ \ | |_) | |_) | |  \| | / _ \ | |\/| |  _|  
 / ___ \|  __/|  __/  | |\  |/ ___ \| |  | | |___ 
/_/   \_\_|   |_|     |_| \_/_/   \_\_|  |_|_____|                  
${clear}
"

echo -e "Let's hope you are not ${red}DUMB${clear}!"; echo

# -----------------------------
# Temp logs + cleanup
# -----------------------------
types_log="$(mktemp -t types_output.XXXXXX)"
lint_log="$(mktemp -t lint_output.XXXXXX)"
cleanup() { rm -f "$types_log" "$lint_log" >/dev/null 2>&1 || true; }
trap cleanup EXIT INT TERM

# -----------------------------
# ORDER: 1) Lint (fix)  2) Stage changes  3) Types
# -----------------------------
run_task "Running linting (fix)"   "$PACKAGE_MANAGER run lint:fix" "$lint_log"

# -----------------------------
# Auto-stage changes from lint fixes
# -----------------------------
if [ -d .git ]; then
  echo -e "${yellow}Staging lint fixes...${clear}"
  git add .
  echo -e "${green}Changes staged${clear} âœ…"
  echo
fi

run_task "Running type checks"     "$PACKAGE_MANAGER run types"    "$types_log"

# -----------------------------
# Final message
# -----------------------------
echo -e "${yellow}Seems like you are a ${red}C${yellow}L${green}E${cyan}V${blue}E${magenta}R ${light_red}D${light_yellow}E${light_green}V${light_cyan}E${light_blue}L${light_magenta}O${light_red}P${light_yellow}E${light_green}R${clear} ðŸ‘Œ"
echo
echo -e "${green}GOOD TO GO${clear} ðŸš€ðŸš€ðŸš€"