# Flow App Theming System Architecture

This document explains how the Flow app's theming system works, designed to help reverse engineer it for React Native.

## Overview

The theming system is built on Flutter's Material Design 3 theming with custom extensions. It supports:
- Multiple theme groups (Flow, Catppuccin, standalone themes)
- Light, dark, and OLED variants
- Custom color extensions for app-specific colors
- Dynamic theme switching
- Auto-generated primary/accent color palettes

## Core Architecture

### 1. Color Scheme Structure

The base structure is `FlowColorScheme`, which wraps Flutter's `ColorScheme` with additional properties:

```dart
class FlowColorScheme {
  final String name;              // Unique theme identifier
  final String? iconName;         // iOS app icon variant name
  final bool isDark;              // Light/dark mode flag
  final Color surface;            // Background color
  final Color onSurface;          // Text color on surface
  final Color primary;            // Primary brand color
  final Color? onPrimary;         // Text color on primary
  final Color secondary;          // Secondary/card background
  final Color? onSecondary;       // Text color on secondary
  final Color? error;             // Error color
  final Color? onError;            // Text color on error
  final FlowCustomColors customColors; // App-specific colors
  late final ColorScheme colorScheme;  // Material ColorScheme
}
```

### 2. Default Base Schemes

The system defines default base schemes for light and dark modes:

**Light Base:**
- `surface`: `#F5F6FA` (light gray)
- `onSurface`: `#0A000D` (near black)
- `primary`: `#8500a6` (purple)
- `onPrimary`: `#f5f6fa` (light gray)
- `secondary`: `#F5CCFF` (light purple)
- `onSecondary`: `#33004F` (dark purple)

**Dark Base:**
- `surface`: `#222222` (dark gray)
- `onSurface`: `#F5F6FA` (light gray)
- `primary`: `#F2C0FF` (light purple)
- `onPrimary`: `#222222` (dark gray)
- `secondary`: `#111111` (near black)
- `onSecondary`: `#f5f6fa` (light gray)

### 3. Theme Generation Process

#### Step 1: Base Theme Definition

Each theme group defines a base `FlowColorScheme`:

```dart
final FlowColorScheme _defaultLightBase = FlowColorScheme(
  name: "defaultLightBase",
  isDark: false,
  surface: const Color(0xfff5f6fa),
  onSurface: const Color(0xff111111),
  primary: const Color(0xff8600a5),
  onPrimary: const Color(0xfff5f6fa),
  secondary: const Color(0xfff5ccff),
  onSecondary: const Color(0xff33004f),
  customColors: FlowCustomColors(
    income: Color(0xFF32CC70),
    expense: Color(0xFFFF4040),
    semi: Color(0xFF6A666D),
  ),
);
```

#### Step 2: Theme Variants via `copyWith`

Themes are generated by copying the base and overriding specific colors:

```dart
_defaultLightBase.copyWith(
  name: "shadeOfViolet",
  iconName: "shadeOfViolet",
  primary: const Color(0xff8600a5),
  secondary: const Color(0xfff5ccff),
  onSecondary: const Color(0xff33004f),
)
```

#### Step 3: ColorScheme Generation

When a `FlowColorScheme` is instantiated, it automatically generates a Material `ColorScheme`:

```dart
FlowColorScheme({...}) {
  final defaultBase = (isDark ? _defaultDarkBase : _defaultLightBase);
  
  colorScheme = defaultBase.copyWith(
    surface: surface,
    onSurface: onSurface,
    primary: primary,
    onPrimary: onPrimary,
    secondary: secondary,
    onSecondary: onSecondary,
    error: error ?? defaultBase.error,
    onError: onError ?? defaultBase.onError,
  );
}
```

### 4. Primary and Accent Colors

The system uses auto-generated color arrays (from `colors.py`):

**Primary Colors** (16 colors):
- Darker, saturated colors for light themes
- Each has a calculated contrast ratio
- Examples: `#8600a5`, `#a50086`, `#a50048`, etc.

**Accent Colors** (16 colors):
- Lighter, pastel versions of primary colors
- Used as secondary colors
- Examples: `#f5ccff`, `#ffccf5`, `#ffcce2`, etc.

The relationship: Each primary color has a corresponding accent color at the same index.

### 5. Theme Groups

Themes are organized into groups:

```dart
class FlowThemeGroup {
  final String name;                    // Group name (e.g., "Flow Light")
  final FlowIconData? icon;            // Group icon
  final List<FlowColorScheme> schemes;  // All themes in group
}
```

**Group Structure:**
- `groups`: Map of group names to lists of `FlowThemeGroup`
- `standaloneThemes`: Individual themes not in groups
- `allThemes`: Flattened map of all themes by name

### 6. Theme Registry

The registry (`color_themes/registry.dart`) manages all themes:

```dart
// Groups
final Map<String, List<FlowThemeGroup>> groups = {
  "Flow": [flowLights, flowDarks, flowOleds],
  "Catppuccin": [catppuccinFrappe, catppuccinMacchiato, catppuccinMocha],
};

// Standalone themes
final Map<String, FlowColorScheme> standaloneThemes = {
  "palenight": palenight,
  "monochrome": monochrome,
};

// All themes flattened
final Map<String, FlowColorScheme> allThemes = {
  ...groups.values.fold(...),  // Flatten groups
  ...standaloneThemes,         // Add standalone
};
```

**Theme Lookup:**
- `getTheme(themeName, preferDark)`: Gets theme with fallback
- `getThemeStrict(themeName)`: Gets theme or null
- `validateThemeName(themeName)`: Checks if theme exists
- `getGroupByTheme(themeName)`: Gets the group containing a theme

### 7. Custom Color Extensions

The app uses `FlowCustomColors` for app-specific colors:

```dart
class FlowCustomColors extends ThemeExtension<FlowCustomColors> {
  final Color income;   // Green for income transactions
  final Color expense;  // Red for expense transactions
  final Color semi;     // Gray for secondary text/labels
}
```

**Extension Methods:**
- `copyWith()`: Creates a copy with modified colors
- `lerp()`: Interpolates between two color schemes (for animations)

### 8. Theme Factory

The `ThemeFactory` converts `FlowColorScheme` to Flutter's `ThemeData`:

```dart
class ThemeFactory {
  final FlowColorScheme flowColorScheme;
  late final ThemeData materialTheme;
  
  ThemeFactory(this.flowColorScheme) {
    // Build Material ThemeData from FlowColorScheme
    materialTheme = ThemeData(
      useMaterial3: true,
      brightness: colorScheme.brightness,
      colorScheme: colorScheme,
      // ... extensive theme configuration
      extensions: [
        flowColorScheme.customColors,
        PieThemeExtension(...),
        NavbarTheme(...),
      ],
    );
  }
}
```

**Key Theme Customizations:**
- AppBar: No elevation, no center title
- Cards: Use secondary color, primary tint
- Chips: Custom label style, selected color
- Icon buttons: State-based colors
- Bottom navigation: Custom active/inactive colors
- Text selection: Theme-aware colors
- Input decoration: Rounded borders, custom hint style

### 9. Additional Theme Extensions

**NavbarTheme:**
- Background color
- Active/inactive icon colors
- Transaction button colors

**PieThemeExtension:**
- Wraps pie menu theme
- Button colors, overlay, tooltip styles

### 10. Text Theme

Static text theme with predefined styles:

```dart
const flowTextTheme = TextTheme(
  displayLarge: TextStyle(fontSize: 48.0, fontWeight: FontWeight.w500),
  displayMedium: TextStyle(fontSize: 36.0, fontWeight: FontWeight.w500),
  // ... more styles
);
```

Applied to Material theme with:
- Font family: "Poppins" (primary)
- Fallback fonts: SF Pro Display, SF UI Text, Helvetica, etc.
- Body/display colors from `colorScheme.onSurface`

### 11. Theme Access Helpers

Extension methods on `BuildContext` for easy access:

```dart
extension ThemeAccessor on BuildContext {
  TextTheme get textTheme => Theme.of(this).textTheme;
  ColorScheme get colorScheme => Theme.of(this).colorScheme;
  FlowCustomColors get flowColors => 
      Theme.of(this).extension<FlowCustomColors>()!;
  PieTheme get pieTheme => 
      Theme.of(this).extension<PieThemeExtension>()!.pieTheme;
}
```

## Theme Variant Patterns

### Flow Light Themes
- Base: Light surface (`#f5f6fa`), dark text (`#111111`)
- Primary: One of 16 primary colors
- Secondary: Corresponding accent color
- Pattern: `_defaultLightBase.copyWith(primary: X, secondary: Y)`

### Flow Dark Themes
- Base: Dark surface (`#141414`), light text (`#f5f6fa`)
- Primary: Lightened version of primary color
- Secondary: Very dark (`#050505`)
- Pattern: `_defaultDarkBase.copyWith(primary: lightenedColor)`

### Flow OLED Themes
- Similar to dark but with true black (`#000000`) surfaces
- Higher contrast for OLED displays

### Catppuccin Themes
- Based on Catppuccin color palette
- Multiple variants per base (Flamingo, Rosewater, Mauve, etc.)
- Custom surface colors from palette

### Standalone Themes
- Individual themes not part of a group
- Examples: `palenight`, `monochrome`
- Fully custom color schemes

## React Native Translation Guide

### 1. Color Scheme Structure

```typescript
interface FlowColorScheme {
  name: string;
  iconName?: string;
  isDark: boolean;
  surface: string;        // Hex color
  onSurface: string;
  primary: string;
  onPrimary?: string;
  secondary: string;
  onSecondary?: string;
  error?: string;
  onError?: string;
  customColors: {
    income: string;
    expense: string;
    semi: string;
  };
}
```

### 2. Theme Registry

```typescript
const groups: Record<string, FlowThemeGroup[]> = {
  "Flow": [flowLights, flowDarks, flowOleds],
  "Catppuccin": [catppuccinFrappe, catppuccinMacchiato, catppuccinMocha],
};

const standaloneThemes: Record<string, FlowColorScheme> = {
  palenight: palenightTheme,
  monochrome: monochromeTheme,
};

const allThemes: Record<string, FlowColorScheme> = {
  ...Object.values(groups).flat().reduce((acc, group) => {
    group.schemes.forEach(scheme => {
      acc[scheme.name] = scheme;
    });
    return acc;
  }, {} as Record<string, FlowColorScheme>),
  ...standaloneThemes,
};
```

### 3. Theme Factory Pattern

```typescript
class ThemeFactory {
  private flowColorScheme: FlowColorScheme;
  public theme: Theme; // Your React Native theme type

  constructor(flowColorScheme: FlowColorScheme) {
    this.flowColorScheme = flowColorScheme;
    this.theme = this.buildTheme();
  }

  private buildTheme(): Theme {
    return {
      colors: {
        primary: this.flowColorScheme.primary,
        background: this.flowColorScheme.surface,
        text: this.flowColorScheme.onSurface,
        // ... map all colors
      },
      customColors: this.flowColorScheme.customColors,
      // ... other theme properties
    };
  }

  static fromThemeName(
    themeName: string | null,
    preferDark: boolean = false
  ): ThemeFactory {
    const scheme = getTheme(themeName, preferDark);
    return new ThemeFactory(scheme);
  }
}
```

### 4. Custom Colors Extension

```typescript
interface CustomColors {
  income: string;
  expense: string;
  semi: string;
}

// In your theme context
const useFlowColors = () => {
  const theme = useTheme();
  return theme.colors.customColors;
};
```

### 5. Theme Groups

```typescript
interface ThemeGroup {
  name: string;
  icon?: string | IconData;
  schemes: FlowColorScheme[];
}

const getGroupByTheme = (themeName: string): ThemeGroup | null => {
  for (const groupList of Object.values(groups)) {
    for (const group of groupList) {
      if (group.schemes.some(s => s.name === themeName)) {
        return group;
      }
    }
  }
  return null;
};
```

## Key Patterns to Replicate

1. **Base + Variants**: Define base schemes, generate variants with `copyWith`-like pattern
2. **Color Arrays**: Primary/accent color arrays with 1:1 correspondence
3. **Theme Groups**: Organize themes into groups for UI display
4. **Registry Pattern**: Central registry for all themes with lookup functions
5. **Factory Pattern**: Convert color scheme to platform-specific theme object
6. **Custom Extensions**: Extend base theme with app-specific colors
7. **Helper Extensions**: Context-based accessors for theme properties

## Color Generation Notes

- Primary colors are darker, saturated (for light themes)
- Accent colors are lighter, pastel versions
- Dark theme primaries are lightened versions
- Contrast ratios are calculated for accessibility
- Colors follow a hue rotation pattern (16 colors around color wheel)

## Theme Switching

The system supports:
- Theme name-based lookup
- Fallback to default theme
- Dark mode preference
- Group-based organization
- iOS app icon changes (via `iconName`)

